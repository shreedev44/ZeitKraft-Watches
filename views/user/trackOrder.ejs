<%- include('../layout/header') -%>

<%- include('../layout/userSideCss') -%>

    <!-- Bootstrap CSS -->
    <title>ZEITKRAFT | Orders</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit-code.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="/UserAssets/css/profile.css" />
    <link rel="stylesheet" href="/UserAssets/css/trackOrder.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
  </head>

  <body>
    <%- include('../layout/navbar') -%>

    <section class="breadcrumb-option">
      <div class="container">
          <div class="row">
              <div class="col-lg-12">
                  <div class="breadcrumb__text">
                      <h4>Profile</h4>
                      <div class="breadcrumb__links">
                          <a href="/home">Home</a>
                          <a href="/orders">Orders</a>
                          <span>Track Order</span>
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </section>

  <div class="container my-5">
    <div class="card">
        <div class="card-body">
            <% let orderedDate = new Date(order.orderDate) %>
            <% orderedDate = orderedDate.toLocaleDateString('default', {day: 'numeric', month: 'short', year: 'numeric'}) %>

            <p>Ordered on: <%= orderedDate %></p>

            <% let lastUpdated = order.lastUpdated.map((date) => {
                return date.toLocaleDateString('default', {day: 'numeric', month: 'short', year: 'numeric'})
            }) %>
            
            <p>Last Updated: <%= lastUpdated[lastUpdated.length - 1] %></p>

            <% let deliveryDate = order.deliveryDate.map((date) => {
                return date.toLocaleDateString('default', {day: 'numeric', month: 'short', year: 'numeric'})
            }) %>

            <h5>Product Details</h5>
            <div class="row mb-3" id="products-whole-div">
                <% products.forEach((product) => { %>
                    <% let i = products.indexOf(product) %>
                    <div class="d-flex flex-column col-lg-12 my-5">

                        <div class="d-flex">
                            <div class="d-flex flex-column">
                                <% if(order.status[i] == 'Out for Delivery'){ %>
                                <span class="lead fw-normal font-weight-bold">Your order is Out for Delivery</span>
                                <% } else { %>
                                <span class="lead fw-normal font-weight-bold">Your order has been <%= order.status[i] %></span>
                                <% } %>
                                <% if(order.status[i] != 'Delivered'){ %>
                                <span>Estimated Delivery Date: <%= deliveryDate[i] %></span>
                                <% } %>
                            </div>
                        </div>

                        <div class="card card-stepper" style="border-radius: 0px;">
                            <div class="card-body p-4">
                                <div class="d-flex flex-row justify-content-between align-items-center align-content-center">
                                    <span class="<%= order.status[i] == 'Cancelled' ? 'dot-danger': 'dot-filled' %>"></span>
                                    <hr class="flex-fill <%= order.status[i] == 'Shipped' || order.status[i] == 'Out for Delivery' || order.status[i] == 'Delivered' ? 'track-line' : '' %>">
                                    <span class="<%= order.status[i] == 'Shipped' || order.status[i] == 'Out for Delivery' || order.status[i] == 'Delivered' ? 'dot-filled' : 'dot' %>"></span>
                                    <hr class="flex-fill <%= order.status[i] == 'Out for Delivery' || order.status[i] == 'Delivered' ? 'track-line' : '' %>">
                                    <span class="<%= order.status[i] == 'Out for Delivery' || order.status[i] == 'Delivered' ? 'dot-filled' : 'dot' %>"></span>
                                    <hr class="flex-fill <%= order.status[i] == 'Delivered' ? 'track-line' : '' %>">
                                    <% if(order.status[i] == 'Delivered'){ %>
                                    <span class="d-flex justify-content-center align-items-center big-dot dot-filled">
                                        <i class="fa fa-check text-white"></i>
                                    </span>
                                    <% } else { %>
                                    <span class="dot"></span>
                                    <% } %>
                                </div>
                                <div class="d-flex flex-row justify-content-between align-items-center">
                                    <div class="d-flex flex-column align-items-start">
                                        <span><%= order.status[i] == 'Cancelled' ? 'Order Cancelled' : 'Order placed' %></span>
                                        <span><%= orderedDate %></span>
                                    </div>
                                    <div class="d-flex flex-column justify-content-center align-items-center">
                                        <span>Order Shipped</span>
                                        <span><%= order.status[i] == 'Shipped' ? lastUpdated[i] : '' %></span>
                                    </div>
                                    <div class="d-flex flex-column align-items-center">
                                        <span>Out for Delivery</span>
                                        <span><%= order.status[i] == 'Out for Delivery' ? lastUpdated[i] : '' %></span>
                                    </div>
                                    <div class="d-flex flex-column align-items-end">
                                        <span>Delivered</span>
                                        <span><%= order.status[i] == 'Delivered' ? lastUpdated[i] : 'Est:' + deliveryDate[i] %></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row px-5">
                        <div class="col-md-3 my-3">
                            <img src="/uploads/products/<%= product.productPic1 %>" class="img-fluid <%= order.status[i] == 'Cancelled' ? 'img-fade' : '' %>" alt="Product Image">
                        </div>
                        <div class="col-md-6">
                            <p><strong>Product Name:</strong> <%= product.brand + " " + product.name %></p>
                            <p><strong>Quantity:</strong> <%= product.quantity %></p>
                            <p><strong>Price:</strong>&#x20b9; <%= product.price.toLocaleString() %></p>
                        </div>
                        <div class="col-md-3 text-md-right">
                            <% let subTotal = product.price * product.quantity %>
                            <p><strong>Subtotal:</strong>&#x20b9; <%= subTotal.toLocaleString() %></p>
                            <% if(order.status[i] == 'Delivered'){ %>
                            <% let returnDate = Number(order.deliveryDate[i]) + 7 * 24 * 60 * 60 * 1000 %>

                            <a href="#" id="return-btn" data-order-id="<%= order._id %>" data-product-id="<%= product._id %>" class="btn btn-danger rounded-0 mb-3 <%= returnDate >= Date.now() ? '' : 'disabled bg-dark' %>">Return</a>
                            
                            <% } else if(order.status[i] != 'Cancelled') { %>

                            <a href="#" id="cancel-btn" data-order-id="<%= order._id %>" data-product-id="<%= product._id %>" class="btn btn-danger rounded-0 mb-3">Cancel</a>
                            
                            <% } %>
                        </div>
                    </div>
                    <% }) %>
                </div>

                <hr>

                <div class="row mb-3">
                    <div class="col-md-9 text-right">
                        <p><strong>Delivery Charge:</strong></p>
                    </div>
                    <div class="col-md-3 text-md-right">
                        <p>&#x20b9; 60</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-9 text-right">
                        <p><strong>Tax Charge:</strong></p>
                    </div>
                    <div class="col-md-3 text-md-right">
                        <p>&#x20b9; <%= order.taxCharge.toLocaleString() %></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-9 text-right">
                        <h5><strong>Total Amount:</strong></h5>
                    </div>
                    <div class="col-md-3 text-md-right">
                        <h5><strong>&#x20b9; <%= order.totalCharge.toLocaleString() %></strong></h5>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-9 text-right">
                        <p><strong>Payment Method:</strong></p>
                    </div>
                    <div class="col-md-3 text-md-right">
                        <p><%= order.paymentMethod %></p>
                    </div>
                </div>

                <hr>

                <div class="row mb-3">
                    <div class="col-md-12">
                        <h2 class="mb-5">Deliver to</h2>
                        <p><strong><%= address.firstName + " " + address.lastName %></strong></p>
                        <p><%= address.streetAddress %></p>
                        <p><%= address.city + ', ' + address.state %></p>
                        <p>PIN: <%= address.pinCode %></p>
                        <p>Phone: +<%= address.phone %></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



    <%- include('../layout/pageFooter') -%>
    
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <%- include('../layout/userSideScripts') -%>
    <script src="/UserAssets/js/trackOrder.js"></script>

<%- include('../layout/footer') -%>